<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Kahuto Pacific — Performance Tracker</title>
<link rel="icon" href="https://content.app-sources.com/s/615296968844647021/thumbnails/640x480/Logos/Kahuto_Short_Logo_White_MID_OWL_2-2482212.png?format=webp">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{--kahuto-dark:#0c1821;--kahuto-navy:#162a3a;--kahuto-mid:#1e3a4f;--kahuto-teal:#2a9d8f;--kahuto-teal-light:#40c9b8;--kahuto-accent:#e9c46a;--green:#16a34a;--green-bg:#dcfce7;--red:#dc2626;--red-bg:#fee2e2;--yellow-bg:#fef9c3;--grey:#f3f6f8;--grey-border:#dde4e9;--text:#1a2a36;--text-light:#5a7080;--text-lighter:#8a9caa;--radius:12px;--shadow:0 1px 4px rgba(12,24,33,0.06),0 2px 6px rgba(12,24,33,0.04);--shadow-lg:0 12px 48px rgba(12,24,33,0.18)}
  *{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:var(--kahuto-dark);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}.hidden{display:none!important}
  .header{background:linear-gradient(135deg,var(--kahuto-dark)0%,var(--kahuto-navy)100%);padding:12px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(0,0,0,0.2)}
  .header-left{display:flex;align-items:center;gap:12px}.header-logo{height:32px;opacity:0.95}.header-brand{color:var(--kahuto-teal-light);font-size:10px;letter-spacing:2.5px;font-weight:600}.header-title{color:#fff;font-size:15px;font-weight:700;margin-top:1px}
  .btn-logout{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.85);padding:7px 14px;border-radius:8px;font-size:12px;font-family:inherit;cursor:pointer;transition:all 0.2s}
  .tabs{background:var(--kahuto-navy);border-bottom:1px solid rgba(255,255,255,0.08);display:flex;padding:0 16px;position:sticky;top:56px;z-index:99}
  .tab{padding:13px 16px;border:none;background:none;font-size:13px;font-weight:600;color:rgba(255,255,255,0.45);cursor:pointer;border-bottom:3px solid transparent;font-family:inherit;position:relative;transition:color 0.2s}
  .tab.active{color:var(--kahuto-teal-light);border-bottom-color:var(--kahuto-teal-light)}.tab .badge{position:absolute;top:8px;right:2px;background:var(--red);color:#fff;border-radius:10px;padding:1px 6px;font-size:10px;font-weight:700}
  .container{max-width:700px;margin:0 auto;padding:16px}.card{background:rgba(255,255,255,0.95);border-radius:var(--radius);padding:20px;box-shadow:0 2px 12px rgba(0,0,0,0.15);margin-bottom:16px;border:1px solid rgba(255,255,255,0.08)}
  .card-title{font-size:15px;font-weight:700;color:var(--kahuto-navy);margin-bottom:4px}.card-sub{font-size:12px;color:var(--text-lighter);margin-bottom:16px}
  .form-label{font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:4px}.form-hint{font-size:11px;color:var(--text-lighter);margin-bottom:4px}
  .form-input,.form-textarea{width:100%;padding:10px 12px;border-radius:8px;border:1.5px solid var(--grey-border);font-size:14px;font-family:inherit;color:var(--text);background:#fff;transition:border-color 0.2s}
  .form-input:focus,.form-textarea:focus{outline:none;border-color:var(--kahuto-teal);box-shadow:0 0 0 3px rgba(42,157,143,0.1)}.form-textarea{resize:vertical;min-height:70px}.form-group{margin-bottom:14px}
  .btn{width:100%;padding:14px;border-radius:10px;border:none;font-weight:700;font-size:15px;font-family:inherit;cursor:pointer;transition:all 0.2s}
  .btn-primary{background:linear-gradient(135deg,var(--kahuto-teal)0%,#238b80 100%);color:#fff;box-shadow:0 2px 8px rgba(42,157,143,0.3)}
  .btn-primary:hover{box-shadow:0 4px 16px rgba(42,157,143,0.4);transform:translateY(-1px)}.btn-primary:disabled{background:#c0cdd4;box-shadow:none;cursor:not-allowed;transform:none}
  .btn-danger{background:rgba(220,38,38,0.08);color:var(--red);font-size:12px;padding:7px 12px;width:auto;border-radius:8px;border:none;font-family:inherit;cursor:pointer}
  .btn-back{background:none;border:none;color:var(--text-lighter);font-size:13px;font-family:inherit;cursor:pointer;padding:0}
  .score-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid #f1f5f9}.score-row:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
  .score-label{font-size:14px;font-weight:600}.score-btns{display:flex;gap:6px}
  .score-btn{width:38px;height:38px;border-radius:8px;border:2px solid;font-weight:700;font-size:15px;cursor:pointer;font-family:inherit;transition:all 0.15s}
  .score-btn[data-v="1"]{border-color:#fca5a5;background:#fee2e2;color:#991b1b}.score-btn[data-v="1"].sel{background:#991b1b;color:#fff}
  .score-btn[data-v="2"]{border-color:#fdba74;background:#ffedd5;color:#9a3412}.score-btn[data-v="2"].sel{background:#9a3412;color:#fff}
  .score-btn[data-v="3"]{border-color:#fde047;background:#fef9c3;color:#854d0e}.score-btn[data-v="3"].sel{background:#854d0e;color:#fff}
  .score-btn[data-v="4"]{border-color:#6ee7b7;background:#d1fae5;color:#065f46}.score-btn[data-v="4"].sel{background:#065f46;color:#fff}
  .score-btn[data-v="5"]{border-color:#5eead4;background:#ccfbf1;color:#134e4a}.score-btn[data-v="5"].sel{background:#134e4a;color:#fff}
  .staff-btns{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
  .staff-btn{flex:0 0 calc(50% - 4px);padding:11px 8px;border-radius:10px;border:2px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);font-weight:600;font-size:13px;font-family:inherit;cursor:pointer;position:relative;color:rgba(255,255,255,0.8);transition:all 0.15s}
  .staff-btn:hover{border-color:var(--kahuto-teal);background:rgba(42,157,143,0.1)}.staff-btn.active{border-color:var(--kahuto-teal);background:var(--kahuto-teal);color:#fff}
  .staff-btn .badge{position:absolute;top:-6px;right:-6px;background:var(--red);color:#fff;border-radius:10px;padding:1px 6px;font-size:10px;font-weight:700}
  .sub-card{background:linear-gradient(135deg,#f0fdf4 0%,#ecfdf5 100%);border-radius:10px;padding:14px;margin-bottom:16px;border:1px solid #bbf7d0}
  .sub-card h4{font-size:12px;color:#166534;margin-bottom:8px;font-weight:700;letter-spacing:0.5px}.sub-item{margin-bottom:6px}.sub-item-label{font-size:11px;font-weight:700;color:#166534}.sub-item-text{font-size:13px;color:var(--text);margin-top:1px}
  .overall-display{text-align:center;padding:14px;background:linear-gradient(135deg,#f0fdfa 0%,#e0f7f3 100%);border-radius:10px;margin:16px 0;border:1px solid #99f6e4}
  .overall-num{font-size:32px;font-weight:700;color:var(--kahuto-navy)}.overall-label{font-size:13px;color:var(--text-light)}
  .table-wrap{overflow-x:auto;margin:0 -20px;padding:0 20px}table{width:100%;border-collapse:collapse;font-size:13px}
  th{background:linear-gradient(135deg,var(--kahuto-dark)0%,var(--kahuto-navy)100%);color:#fff;padding:10px 8px;text-align:center;font-weight:600;font-size:11px;white-space:nowrap}
  th:first-child{border-radius:8px 0 0 0}th:last-child{border-radius:0 8px 0 0}td{padding:10px 8px;text-align:center;border-bottom:1px solid #f1f5f9}td:first-child{text-align:left;font-weight:700;color:var(--kahuto-navy)}
  .hist-item{border-bottom:1px solid #f1f5f9;padding-bottom:12px;margin-bottom:12px}.hist-item:last-child{border:none;margin:0;padding:0}
  .hist-top{display:flex;justify-content:space-between;align-items:center}.hist-date{font-weight:700;color:var(--kahuto-navy);font-size:14px}
  .hist-badge{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:700}.hist-scores{display:flex;gap:12px;margin-top:6px;font-size:12px;color:var(--text-light);flex-wrap:wrap}
  .hist-comment{font-size:12px;color:var(--text-light);margin-top:4px;font-style:italic}.hist-meta{font-size:11px;color:var(--text-lighter);margin-top:2px}
  .pending-btn{display:block;width:100%;text-align:left;padding:12px 14px;border-radius:8px;border:1.5px solid var(--grey-border);background:#fff;cursor:pointer;margin-bottom:8px;font-family:inherit;transition:all 0.15s}
  .pending-btn:hover{border-color:var(--kahuto-teal);background:#f0fdfa}.pending-date{font-weight:700;color:var(--kahuto-navy);font-size:14px}.pending-preview{font-size:12px;color:var(--text-light);margin-top:3px}
  .alert-box{background:rgba(42,157,143,0.08);border:1px solid rgba(42,157,143,0.2);border-radius:var(--radius);padding:16px}
  .alert-box h3{font-size:13px;color:var(--kahuto-teal-light);margin-bottom:10px;font-weight:700}.alert-item{display:flex;gap:8px;margin-bottom:5px;font-size:13px;color:rgba(255,255,255,0.7)}.alert-num{font-weight:700;min-width:18px}
  .rating-row{display:flex;gap:10px;align-items:center;padding:8px 10px;margin-bottom:3px;border-radius:6px;font-size:13px}.rating-score{font-weight:700;min-width:75px}.rating-label{font-weight:700;min-width:120px}.rating-desc{color:var(--text-light)}
  .login-screen{min-height:100vh;background:var(--kahuto-dark);display:flex;align-items:center;justify-content:center;padding:20px;position:relative;overflow:hidden}
  .login-screen::before{content:'';position:absolute;inset:0;background:
    radial-gradient(ellipse 800px 600px at 20% 80%,rgba(42,157,143,0.15),transparent),
    radial-gradient(ellipse 600px 400px at 80% 20%,rgba(42,157,143,0.08),transparent),
    radial-gradient(ellipse 400px 300px at 50% 50%,rgba(30,58,79,0.6),transparent);z-index:0}
  .login-screen::after{content:'';position:absolute;inset:0;opacity:0.08;z-index:0;
    background-image:
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='800'%3E%3Cellipse cx='400' cy='400' rx='350' ry='280' fill='none' stroke='%232a9d8f' stroke-width='1'/%3E%3Cellipse cx='400' cy='400' rx='300' ry='240' fill='none' stroke='%232a9d8f' stroke-width='0.8'/%3E%3Cellipse cx='400' cy='400' rx='250' ry='200' fill='none' stroke='%232a9d8f' stroke-width='0.8'/%3E%3Cellipse cx='400' cy='400' rx='200' ry='160' fill='none' stroke='%232a9d8f' stroke-width='0.6'/%3E%3Cellipse cx='400' cy='400' rx='150' ry='120' fill='none' stroke='%232a9d8f' stroke-width='0.6'/%3E%3Cellipse cx='400' cy='400' rx='100' ry='80' fill='none' stroke='%232a9d8f' stroke-width='0.5'/%3E%3Cellipse cx='400' cy='400' rx='50' ry='40' fill='none' stroke='%232a9d8f' stroke-width='0.5'/%3E%3Cellipse cx='200' cy='600' rx='180' ry='140' fill='none' stroke='%232a9d8f' stroke-width='0.6'/%3E%3Cellipse cx='200' cy='600' rx='130' ry='100' fill='none' stroke='%232a9d8f' stroke-width='0.5'/%3E%3Cellipse cx='200' cy='600' rx='80' ry='60' fill='none' stroke='%232a9d8f' stroke-width='0.4'/%3E%3Cellipse cx='650' cy='200' rx='140' ry='110' fill='none' stroke='%232a9d8f' stroke-width='0.6'/%3E%3Cellipse cx='650' cy='200' rx='90' ry='70' fill='none' stroke='%232a9d8f' stroke-width='0.5'/%3E%3Cellipse cx='650' cy='200' rx='40' ry='30' fill='none' stroke='%232a9d8f' stroke-width='0.4'/%3E%3C/svg%3E");
    background-size:100% 100%}
  .login-topo{position:absolute;bottom:0;left:0;right:0;height:200px;z-index:0;opacity:0.12;
    background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 200'%3E%3Cpath fill='none' stroke='%232a9d8f' stroke-width='1.5' d='M0,160 C240,120 480,180 720,140 C960,100 1200,160 1440,130'/%3E%3Cpath fill='none' stroke='%232a9d8f' stroke-width='1' d='M0,140 C240,100 480,160 720,120 C960,80 1200,140 1440,110'/%3E%3Cpath fill='none' stroke='%232a9d8f' stroke-width='0.8' d='M0,120 C240,80 480,140 720,100 C960,60 1200,120 1440,90'/%3E%3Cpath fill='none' stroke='%232a9d8f' stroke-width='0.6' d='M0,100 C240,60 480,120 720,80 C960,40 1200,100 1440,70'/%3E%3Cpath fill='none' stroke='%2340c9b8' stroke-width='0.4' d='M0,80 C240,40 480,100 720,60 C960,20 1200,80 1440,50'/%3E%3C/svg%3E") no-repeat bottom/cover}
  .login-card{background:rgba(255,255,255,0.97);border-radius:20px;padding:36px;max-width:400px;width:100%;text-align:center;box-shadow:0 16px 64px rgba(0,0,0,0.4),0 0 0 1px rgba(42,157,143,0.1);position:relative;z-index:1;backdrop-filter:blur(10px)}
  .login-logo{height:48px;margin-bottom:8px}.login-brand{font-size:12px;font-weight:700;color:var(--kahuto-teal);letter-spacing:3px;margin-bottom:2px}
  .login-title{font-size:20px;color:var(--kahuto-navy);font-weight:700;margin:6px 0 20px}.login-sub{font-size:13px;color:var(--text-light);margin-bottom:20px}
  .login-btn{display:block;width:100%;padding:13px;border-radius:10px;font-weight:700;font-size:14px;font-family:inherit;cursor:pointer;margin-bottom:10px;transition:all 0.2s}
  .login-btn-outline{background:#fff;color:var(--kahuto-navy);border:2px solid var(--kahuto-navy)}.login-btn-outline:hover{background:var(--kahuto-navy);color:#fff}
  .login-btn-fill{background:linear-gradient(135deg,var(--kahuto-teal)0%,#238b80 100%);color:#fff;border:2px solid var(--kahuto-teal);box-shadow:0 2px 8px rgba(42,157,143,0.3)}
  .login-btn-fill:hover{box-shadow:0 4px 16px rgba(42,157,143,0.4);transform:translateY(-1px)}
  .login-back{background:none;border:none;color:var(--text-lighter);cursor:pointer;font-size:13px;font-family:inherit;margin-top:12px}
  .pin-input{width:140px;padding:12px;border-radius:10px;border:2px solid var(--grey-border);font-size:22px;text-align:center;letter-spacing:8px;font-family:inherit;transition:border-color 0.2s}
  .pin-input:focus{outline:none;border-color:var(--kahuto-teal)}.pin-input.error{border-color:var(--red)}.pin-error{color:var(--red);font-size:13px;margin-top:6px}
  .toast{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--kahuto-teal)0%,#238b80 100%);color:#fff;padding:10px 24px;border-radius:10px;font-weight:600;font-size:14px;z-index:200;box-shadow:0 4px 20px rgba(42,157,143,0.4);animation:toastIn 0.3s ease}
  @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
  .empty{background:#0f2d3d;border-radius:var(--radius);padding:24px;text-align:center;color:var(--kahuto-teal-light);font-size:14px;border:1px dashed rgba(42,157,143,0.4)}
</style>
</head>
<body>
<div id="app"></div>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js" onerror="window._fbFail=true"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js" onerror="window._fbFail=true"></script>
<script>
// =====================================================
// FIREBASE CONFIG — REPLACE WITH YOUR OWN VALUES
// =====================================================
const firebaseConfig={apiKey:"AIzaSyAfSpsRXf6gpn0ZORkC7T8Z-O9zAlhbGSo",authDomain:"kahuto-performance-tracker.firebaseapp.com",databaseURL:"https://kahuto-performance-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"kahuto-performance-tracker",storageBucket:"kahuto-performance-tracker.firebasestorage.app",messagingSenderId:"567102331840",appId:"1:567102331840:web:75c4410e2e46a55aaec625"};

// =====================================================
// SETTINGS — EDIT THESE AS NEEDED
// =====================================================
const STAFF=["Solomon Chant","Kavitesh Prasad","Neha Naidu","Geeta Singh","Jone Nawele","Audrey D'Cruz","Jennifer Cortez"];
const MANAGERS=["Chris","Nina","Nikhil"];
const MANAGER_PIN="2026";
const CRITERIA=["Productivity","Initiative","Quality","Development"];
const LOGO_W="https://content.app-sources.com/s/615296968844647021/uploads/Logos/Kahuto_Logo_White-2226739.png?format=webp";
const LOGO_O="https://content.app-sources.com/s/615296968844647021/thumbnails/640x480/Logos/Kahuto_Short_Logo_White_MID_OWL_2-2482212.png?format=webp";
const BETWEEN=[
"Equipment maintenance & calibration (drones, GPR, GPS, scanners)",
"Online training — QGIS, CloudCompare, LiDAR processing",
"Shadow a colleague — learn a skill you don't have",
"Improve SOPs, templates, checklists, or field procedures",
"Practice processing on sample/test datasets",
"Organise and back up project files & deliverables",
"Read technical articles or watch tutorials",
"Propose an idea or improvement to management"];
const RATINGS=[
{range:"4.5 – 5.0",label:"Outstanding",color:"#dcfce7",desc:"Exceeds expectations consistently"},
{range:"3.5 – 4.4",label:"Good",color:"#dcfce7",desc:"Solid performer, shows initiative"},
{range:"2.5 – 3.4",label:"Meets Expectations",color:"#fef9c3",desc:"Does what's asked, rarely more"},
{range:"1.5 – 2.4",label:"Below Average",color:"#fee2e2",desc:"Needs improvement"},
{range:"1.0 – 1.4",label:"Poor",color:"#fee2e2",desc:"Immediate action required"}];
let S={screen:"login",role:null,user:null,mt:"evaluate",es:STAFF[0],ew:null,sc:{},ec:"",logs:{},evals:{},toast:null};

// =====================================================
// STORAGE — Firebase with localStorage fallback
// =====================================================
let db=null;
let useLocal=false;
try{
  if(typeof firebase!=="undefined"&&!window._fbFail){
    firebase.initializeApp(firebaseConfig);db=firebase.database();
  }else{useLocal=true}
}catch(e){useLocal=true;console.log("Using local storage mode")}

function lsGet(k){try{return JSON.parse(localStorage.getItem(k))||{}}catch(e){return{}}}
function lsSave(){try{localStorage.setItem("kp_logs",JSON.stringify(S.logs));localStorage.setItem("kp_evals",JSON.stringify(S.evals))}catch(e){}}

function loadData(cb){
  if(useLocal||!db){S.logs=lsGet("kp_logs");S.evals=lsGet("kp_evals");cb();return}
  db.ref("logs").on("value",s=>{S.logs=s.val()||{};render()});
  db.ref("evals").on("value",s=>{S.evals=s.val()||{};render()});cb();
}
async function saveLog(k,d){
  S.logs[k]=d;
  if(!useLocal&&db){await db.ref("logs/"+k).set(d)}else{lsSave()}
}
async function saveEval(k,d){
  S.evals[k]=d;
  if(!useLocal&&db){await db.ref("evals/"+k).set(d)}else{lsSave()}
}
async function resetAll(){
  S.logs={};S.evals={};
  if(!useLocal&&db){await db.ref("logs").remove();await db.ref("evals").remove()}else{lsSave()}
}
function gw(){const d=new Date(),dy=d.getDay(),df=d.getDate()-dy+(dy===0?-6:5),f=new Date(d);f.setDate(df);return f.toISOString().split("T")[0]}
function fd(s){if(!s)return"";return new Date(s+"T00:00:00").toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}
function sk(s){return s.replace(/[.#$\/\[\]]/g,"_")}
function gl(n){return Object.entries(S.logs).filter(([_,l])=>l.staff===n).map(([k,v])=>({...v,_k:k})).sort((a,b)=>b.week.localeCompare(a.week))}
function ge(n){return Object.entries(S.evals).filter(([_,e])=>e.staff===n).map(([k,v])=>({...v,_k:k})).sort((a,b)=>b.week.localeCompare(a.week))}
function gu(n){return gl(n).filter(l=>!S.evals[sk(n+"-"+l.week)])}
function af(n,f){const e=ge(n);if(!e.length)return null;const v=e.map(x=>x.scores&&x.scores[f]).filter(Boolean);return v.length?Math.round(v.reduce((a,b)=>a+b,0)/v.length*10)/10:null}
function oa(n){const e=ge(n);if(!e.length)return null;const v=e.map(x=>x.overall).filter(Boolean);return v.length?Math.round(v.reduce((a,b)=>a+b,0)/v.length*10)/10:null}
function gr(s){if(!s)return{label:"-",color:"#f3f4f6"};if(s>=4.5)return RATINGS[0];if(s>=3.5)return RATINGS[1];if(s>=2.5)return RATINGS[2];if(s>=1.5)return RATINGS[3];return RATINGS[4]}
function toast(m){S.toast=m;render();setTimeout(()=>{S.toast=null;render()},3000)}
function $(id){return document.getElementById(id)}
function render(){const a=$("app");if(S.screen==="login")a.innerHTML=loginScr();else if(S.screen==="staffSel")a.innerHTML=staffSelScr();else if(S.screen==="mgrPin")a.innerHTML=mgrPinScr();else if(S.screen==="staffApp")a.innerHTML=staffAppScr();else if(S.screen==="mgrApp")a.innerHTML=mgrAppScr();bindEv()}
function loginScr(){return'<div class="login-screen"><div class="login-card"><img src="'+LOGO_O+'" class="login-logo" alt="Kahuto" onerror="this.style.display=\'none\'"><div class="login-brand">KAHUTO PACIFIC</div><h1 class="login-title">Performance Tracker</h1><p class="login-sub">Select your role to continue</p><button class="login-btn login-btn-outline" data-action="goStaff">I\'m Staff — Submit Weekly Log</button><button class="login-btn login-btn-fill" data-action="goMgr">I\'m a Manager — Evaluate Staff</button></div></div>'}
function staffSelScr(){return'<div class="login-screen"><div class="login-card" style="max-width:420px"><img src="'+LOGO_O+'" class="login-logo" alt="Kahuto" onerror="this.style.display=\'none\'"><div class="login-brand">KAHUTO PACIFIC</div><h1 class="login-title">Who are you?</h1><div style="max-height:380px;overflow-y:auto;padding:4px 0">'+STAFF.map(s=>'<button class="login-btn login-btn-outline" data-action="selStaff" data-name="'+s+'" style="font-size:14px;padding:12px">'+s+'</button>').join('')+'</div><button class="login-back" data-action="back">← Back</button></div></div>'}
function mgrPinScr(){return'<div class="login-screen"><div class="login-card"><img src="'+LOGO_O+'" class="login-logo" alt="Kahuto" onerror="this.style.display=\'none\'"><div class="login-brand">KAHUTO PACIFIC</div><h1 class="login-title">Manager Access</h1><p class="login-sub">Enter PIN to continue</p><input type="password" id="pin" class="pin-input" maxlength="4" placeholder="••••" autocomplete="off"><div id="pinErr" class="pin-error hidden">Wrong PIN</div><div style="margin-top:16px">'+MANAGERS.map(m=>'<button class="login-btn login-btn-fill" data-action="loginMgr" data-name="'+m+'" style="margin-bottom:8px">Continue as '+m+'</button>').join('')+'</div><button class="login-back" data-action="back">← Back</button></div></div>'}
function staffAppScr(){const n=S.user,w=gw(),ex=S.logs[sk(n+"-"+w)],ml=gl(n);
return'<div class="header"><div class="header-left"><img src="'+LOGO_W+'" class="header-logo" alt="Kahuto" onerror="this.style.display=\'none\'"><div><div class="header-brand">PERFORMANCE TRACKER</div><div class="header-title">'+n+'</div></div></div><button class="btn-logout" data-action="logout">Logout</button></div>'+(S.toast?'<div class="toast">'+S.toast+'</div>':'')+'<div class="container"><div class="card"><div class="card-title">Submit This Week\'s Log</div><div class="card-sub">Week ending: <strong>'+fd(w)+'</strong>'+(ex?' <span style="color:#f59e0b">(Already submitted — will update)</span>':'')+'</div><div class="form-group"><label class="form-label">Week Ending Date</label><input type="date" id="lw" class="form-input" value="'+w+'"></div>'+
[{id:"lp",l:"What project work did you do?",h:'Be specific — which site, what task. If none, write "No active projects."',v:ex?ex.project||"":""},
{id:"lt",l:"What did you learn or train on?",h:'Courses, tutorials, software practice. If nothing, write "None."',v:ex?ex.training||"":""},
{id:"li",l:"What did you do WITHOUT being asked?",h:"Fixed something? Improved a process? Organised files?",v:ex?ex.initiative||"":""},
{id:"lc",l:"Cross-training (taught or learned from a colleague)?",h:"Who and what?",v:ex?ex.crossTraining||"":""},
{id:"lb",l:"Blockers or notes?",h:"Challenges, equipment issues, things you need",v:ex?ex.blockers||"":""}
].map(f=>'<div class="form-group"><label class="form-label">'+f.l+'</label><div class="form-hint">'+f.h+'</div><textarea id="'+f.id+'" class="form-textarea" rows="3">'+f.v+'</textarea></div>').join('')+
'<button class="btn btn-primary" data-action="subLog">'+(ex?"Update Log":"Submit Log")+'</button></div>'+
(ml.length?'<div class="card"><div class="card-title">My Past Submissions</div>'+ml.map(l=>{const ev=S.evals[sk(n+"-"+l.week)],r=ev?gr(ev.overall):null;return'<div class="hist-item"><div class="hist-top"><span class="hist-date">'+fd(l.week)+'</span>'+(ev?'<span class="hist-badge" style="background:'+r.color+'">'+ev.overall+'/5</span>':'<span style="color:var(--text-lighter);font-size:12px">Pending review</span>')+'</div><p style="font-size:12px;color:var(--text-light);margin-top:4px">'+((l.project||"").substring(0,100))+((l.project||"").length>100?"...":"")+'</p></div>'}).join('')+'</div>':'')+
'<div class="alert-box"><h3>No Active Projects? Here\'s What You Should Be Doing:</h3>'+BETWEEN.map((x,i)=>'<div class="alert-item"><span class="alert-num">'+(i+1)+'.</span><span>'+x+'</span></div>').join('')+'</div></div>'}
function mgrAppScr(){const au=STAFF.reduce((n,s)=>n+gu(s).length,0);
return'<div class="header"><div class="header-left"><img src="'+LOGO_W+'" class="header-logo" alt="Kahuto" onerror="this.style.display=\'none\'"><div><div class="header-brand">PERFORMANCE TRACKER</div><div class="header-title">Manager — '+S.user+'</div></div></div><div style="display:flex;gap:6px"><button class="btn-danger" data-action="reset">Reset</button><button class="btn-logout" data-action="logout">Logout</button></div></div>'+(S.toast?'<div class="toast">'+S.toast+'</div>':'')+
'<div class="tabs"><button class="tab '+(S.mt==="evaluate"?"active":"")+'" data-action="tab" data-tab="evaluate">Evaluate'+(au>0?' <span class="badge">'+au+'</span>':'')+'</button><button class="tab '+(S.mt==="dashboard"?"active":"")+'" data-action="tab" data-tab="dashboard">Dashboard</button><button class="tab '+(S.mt==="history"?"active":"")+'" data-action="tab" data-tab="history">History</button></div><div class="container">'+(S.mt==="evaluate"?evalTab():"")+(S.mt==="dashboard"?dashTab():"")+(S.mt==="history"?histTab():"")+'</div>'}
function evalTab(){const es=S.es,pend=gu(es),ew=S.ew,log=ew?S.logs[sk(es+"-"+ew)]:null;
let c='<div class="staff-btns">'+STAFF.map(s=>{const p=gu(s).length;return'<button class="staff-btn '+(S.es===s?"active":"")+'" data-action="setES" data-name="'+s+'">'+s.split(" ")[0]+(p>0?' <span class="badge">'+p+'</span>':'')+'</button>'}).join('')+'</div>';
if(!ew){if(!pend.length)c+='<div class="empty">No pending logs for '+es.split(" ")[0]+'. All caught up! ✓</div>';
else{c+='<div class="card"><div class="card-title">Pending Evaluations — '+es+'</div>';pend.forEach(l=>{c+='<button class="pending-btn" data-action="startEv" data-week="'+l.week+'"><div class="pending-date">'+fd(l.week)+'</div><div class="pending-preview">'+((l.project||"").substring(0,80))+'...</div></button>'});c+='</div>'}}
else if(log){const allSc=CRITERIA.every(cr=>S.sc[cr]);
c+='<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div class="card-title" style="margin:0">Evaluating '+es+' — '+fd(ew)+'</div><button class="btn-back" data-action="cancelEv">← Back</button></div>';
c+='<div class="sub-card"><h4>THEIR SUBMISSION</h4>';
if(log.project)c+='<div class="sub-item"><div class="sub-item-label">Project Work:</div><div class="sub-item-text">'+log.project+'</div></div>';
if(log.training)c+='<div class="sub-item"><div class="sub-item-label">Training:</div><div class="sub-item-text">'+log.training+'</div></div>';
if(log.initiative)c+='<div class="sub-item"><div class="sub-item-label">Initiative:</div><div class="sub-item-text">'+log.initiative+'</div></div>';
if(log.crossTraining)c+='<div class="sub-item"><div class="sub-item-label">Cross-Training:</div><div class="sub-item-text">'+log.crossTraining+'</div></div>';
if(log.blockers)c+='<div class="sub-item"><div class="sub-item-label">Blockers:</div><div class="sub-item-text">'+log.blockers+'</div></div>';
c+='</div><h4 style="font-size:14px;color:var(--kahuto-navy);margin-bottom:12px">Your Scores</h4>';
CRITERIA.forEach(cr=>{c+='<div class="score-row"><span class="score-label">'+cr+'</span><div class="score-btns">';[1,2,3,4,5].forEach(v=>{c+='<button class="score-btn '+(S.sc[cr]===v?"sel":"")+'" data-v="'+v+'" data-action="score" data-cr="'+cr+'" data-val="'+v+'">'+v+'</button>'});c+='</div></div>'});
if(allSc)c+='<div class="overall-display"><div class="overall-label">Overall Score</div><div class="overall-num">'+(CRITERIA.reduce((s,cr)=>s+S.sc[cr],0)/4).toFixed(1)+'</div><div class="overall-label">/ 5</div></div>';
c+='<div class="form-group"><textarea id="ec" class="form-textarea" rows="2" placeholder="Any comments? (optional)">'+S.ec+'</textarea></div><button class="btn btn-primary" data-action="subEval" '+(allSc?"":"disabled")+'>Save Evaluation</button></div>'}
return c}
function dashTab(){return'<div class="card"><div class="card-title">Team Comparison</div><div class="table-wrap"><table><thead><tr><th>Staff</th><th>Wks</th>'+CRITERIA.map(c=>'<th>'+c.substring(0,4)+'</th>').join('')+'<th>OVERALL</th></tr></thead><tbody>'+STAFF.map(s=>{const o=oa(s),r=gr(o);return'<tr><td>'+s.split(" ")[0]+'</td><td>'+ge(s).length+'</td>'+CRITERIA.map(c=>'<td style="font-weight:600">'+(af(s,c)??"-")+'</td>').join('')+'<td style="font-weight:700;font-size:15px;color:var(--kahuto-navy);background:'+r.color+'">'+(o??"-")+'</td></tr>'}).join('')+'</tbody></table></div></div><div class="card"><div class="card-title">Rating Guide</div>'+RATINGS.map(r=>'<div class="rating-row" style="background:'+r.color+'"><span class="rating-score">'+r.range+'</span><span class="rating-label">'+r.label+'</span><span class="rating-desc">'+r.desc+'</span></div>').join('')+'</div><div class="alert-box"><h3>Between Projects — Expected Activities</h3>'+BETWEEN.map((x,i)=>'<div class="alert-item"><span class="alert-num">'+(i+1)+'.</span><span>'+x+'</span></div>').join('')+'</div>'}
function histTab(){return STAFF.map(s=>{const evs=ge(s),o=oa(s);return'<div class="card"><div class="card-title">'+s+'</div><div class="card-sub">'+evs.length+' week'+(evs.length!==1?"s":"")+" evaluated"+(o?" • Overall: "+o+"/5":"")+'</div>'+(evs.length===0?'<div class="empty">No evaluations yet.</div>':evs.map(ev=>{const r=gr(ev.overall),log=S.logs[sk(s+"-"+ev.week)];return'<div class="hist-item"><div class="hist-top"><span class="hist-date">'+fd(ev.week)+'</span><span class="hist-badge" style="background:'+r.color+'">'+ev.overall+'/5 — '+r.label+'</span></div><div class="hist-scores">'+CRITERIA.map(c=>'<span>'+c+': <strong>'+ev.scores[c]+'</strong></span>').join('')+'</div>'+(ev.comment?'<div class="hist-comment">"'+ev.comment+'"</div>':'')+(log?'<p style="font-size:11px;color:var(--text-lighter);margin-top:2px">Project: '+((log.project||"").substring(0,80))+'</p>':'')+'<div class="hist-meta">Evaluated by '+ev.evaluator+'</div></div>'}).join(''))+'</div>'}).join('')}
function bindEv(){document.querySelectorAll("[data-action]").forEach(el=>{el.onclick=e=>{e.preventDefault();ha(el.dataset.action,el.dataset)}})}
async function ha(a,d){switch(a){
case"goStaff":S.screen="staffSel";S.role="staff";break;
case"goMgr":S.screen="mgrPin";S.role="manager";break;
case"back":S.screen="login";S.role=null;S.user=null;break;
case"selStaff":S.user=d.name;S.screen="staffApp";break;
case"loginMgr":{const p=$("pin").value;if(p===MANAGER_PIN){S.user=d.name;S.screen="mgrApp";S.mt="evaluate"}else{$("pin").classList.add("error");$("pinErr").classList.remove("hidden");return}break}
case"logout":S.screen="login";S.role=null;S.user=null;S.ew=null;S.sc={};S.ec="";break;
case"tab":S.mt=d.tab;break;
case"setES":S.es=d.name;S.ew=null;S.sc={};S.ec="";break;
case"startEv":S.ew=d.week;S.sc={};S.ec="";break;
case"cancelEv":S.ew=null;S.sc={};S.ec="";break;
case"score":S.sc[d.cr]=parseInt(d.val);break;
case"subLog":{const w=$("lw").value,p=$("lp").value.trim(),t=$("lt").value.trim(),i=$("li").value.trim(),cr=$("lc").value.trim(),b=$("lb").value.trim();if(!p&&!t&&!i){alert("Please fill in at least one field.");return}const k=sk(S.user+"-"+w);await saveLog(k,{staff:S.user,week:w,project:p,training:t,initiative:i,crossTraining:cr,blockers:b,submittedAt:new Date().toISOString()});toast("Weekly log submitted!");return}
case"subEval":{if(!CRITERIA.every(c=>S.sc[c]))return;const cm=$("ec")?$("ec").value.trim():"",avg=CRITERIA.reduce((s,c)=>s+S.sc[c],0)/4,k=sk(S.es+"-"+S.ew);await saveEval(k,{staff:S.es,week:S.ew,scores:{...S.sc},overall:Math.round(avg*10)/10,evaluator:S.user,comment:cm,evaluatedAt:new Date().toISOString()});S.ew=null;S.sc={};S.ec="";toast("Evaluation saved!");return}
case"reset":{if(!confirm("DELETE all data? Cannot be undone."))return;await resetAll();toast("All data cleared.");break}}render()}
loadData(()=>render());
</script>
</body>
</html>
