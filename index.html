<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Kahuto Pacific — Performance Tracker</title>
<link rel="icon" href="https://content.app-sources.com/s/615296968844647021/thumbnails/640x480/Logos/Kahuto_Short_Logo_White_MID_OWL_2-2482212.png?format=webp">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{--kahuto-dark:#0c1821;--kahuto-navy:#162a3a;--kahuto-mid:#1e3a4f;--kahuto-teal:#2a9d8f;--kahuto-teal-light:#40c9b8;--kahuto-accent:#e9c46a;--green:#16a34a;--green-bg:#dcfce7;--red:#dc2626;--red-bg:#fee2e2;--yellow-bg:#fef9c3;--grey:#f3f6f8;--grey-border:#dde4e9;--text:#1a2a36;--text-light:#5a7080;--text-lighter:#8a9caa;--radius:12px;--shadow:0 1px 4px rgba(12,24,33,0.06),0 2px 6px rgba(12,24,33,0.04);--shadow-lg:0 12px 48px rgba(12,24,33,0.18)}
  *{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:#fbbf24;color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}.hidden{display:none!important}
  .header{background:#1a1a1a;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(0,0,0,0.3)}
  .header-left{display:flex;align-items:center;gap:12px}.header-logo{height:32px;opacity:0.95}.header-brand{color:#fbbf24;font-size:10px;letter-spacing:2.5px;font-weight:600}.header-title{color:#fff;font-size:15px;font-weight:700;margin-top:1px}
  .btn-logout{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.85);padding:7px 14px;border-radius:8px;font-size:12px;font-family:inherit;cursor:pointer;transition:all 0.2s}
  .tabs{background:#262626;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;padding:0 16px;position:sticky;top:56px;z-index:99}
  .tab{padding:13px 16px;border:none;background:none;font-size:13px;font-weight:600;color:rgba(255,255,255,0.5);cursor:pointer;border-bottom:3px solid transparent;font-family:inherit;position:relative;transition:color 0.2s}
  .tab.active{color:#fbbf24;border-bottom-color:#fbbf24}.tab .badge{position:absolute;top:8px;right:2px;background:var(--red);color:#fff;border-radius:10px;padding:1px 6px;font-size:10px;font-weight:700}
  .container{max-width:700px;margin:0 auto;padding:16px}.card{background:rgba(255,255,255,0.95);border-radius:var(--radius);padding:20px;box-shadow:0 2px 12px rgba(0,0,0,0.15);margin-bottom:16px;border:1px solid rgba(255,255,255,0.08)}
  .card-title{font-size:15px;font-weight:700;color:#1a1a1a;margin-bottom:4px}.card-sub{font-size:12px;color:var(--text-lighter);margin-bottom:16px}
  .form-label{font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:4px}.form-hint{font-size:11px;color:var(--text-lighter);margin-bottom:4px}
  .form-input,.form-textarea{width:100%;padding:10px 12px;border-radius:8px;border:1.5px solid var(--grey-border);font-size:14px;font-family:inherit;color:var(--text);background:#fff;transition:border-color 0.2s}
  .form-input:focus,.form-textarea:focus{outline:none;border-color:#d97706;box-shadow:0 0 0 3px rgba(251,191,36,0.2)}.form-textarea{resize:vertical;min-height:70px}.form-group{margin-bottom:14px}
  .btn{width:100%;padding:14px;border-radius:10px;border:none;font-weight:700;font-size:15px;font-family:inherit;cursor:pointer;transition:all 0.2s}
  .btn-primary{background:#1a1a1a;color:#fbbf24;box-shadow:0 2px 8px rgba(0,0,0,0.2);font-weight:700}
  .btn-primary:hover{box-shadow:0 4px 16px rgba(0,0,0,0.3);transform:translateY(-1px)}.btn-primary:disabled{background:#c0cdd4;box-shadow:none;cursor:not-allowed;transform:none}
  .btn-danger{background:rgba(220,38,38,0.08);color:var(--red);font-size:12px;padding:7px 12px;width:auto;border-radius:8px;border:none;font-family:inherit;cursor:pointer}
  .btn-back{background:none;border:none;color:var(--text-lighter);font-size:13px;font-family:inherit;cursor:pointer;padding:0}
  .score-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid #f1f5f9}.score-row:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
  .score-label{font-size:14px;font-weight:600}.score-btns{display:flex;gap:6px}
  .score-btn{width:38px;height:38px;border-radius:8px;border:2px solid;font-weight:700;font-size:15px;cursor:pointer;font-family:inherit;transition:all 0.15s}
  .score-btn[data-v="1"]{border-color:#fca5a5;background:#fee2e2;color:#991b1b}.score-btn[data-v="1"].sel{background:#991b1b;color:#fff}
  .score-btn[data-v="2"]{border-color:#fdba74;background:#ffedd5;color:#9a3412}.score-btn[data-v="2"].sel{background:#9a3412;color:#fff}
  .score-btn[data-v="3"]{border-color:#fde047;background:#fef9c3;color:#854d0e}.score-btn[data-v="3"].sel{background:#854d0e;color:#fff}
  .score-btn[data-v="4"]{border-color:#6ee7b7;background:#d1fae5;color:#065f46}.score-btn[data-v="4"].sel{background:#065f46;color:#fff}
  .score-btn[data-v="5"]{border-color:#5eead4;background:#ccfbf1;color:#134e4a}.score-btn[data-v="5"].sel{background:#134e4a;color:#fff}
  .staff-btns{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
  .staff-btn{flex:0 0 calc(50% - 4px);padding:11px 8px;border-radius:10px;border:2px solid #d97706;background:rgba(251,191,36,0.1);font-weight:600;font-size:13px;font-family:inherit;cursor:pointer;position:relative;color:#1a1a1a;transition:all 0.15s}
  .staff-btn:hover{background:rgba(251,191,36,0.2)}.staff-btn.active{border-color:#1a1a1a;background:#1a1a1a;color:#fbbf24}
  .staff-btn .badge{position:absolute;top:-6px;right:-6px;background:var(--red);color:#fff;border-radius:10px;padding:1px 6px;font-size:10px;font-weight:700}
  .sub-card{background:linear-gradient(135deg,#f0fdf4 0%,#ecfdf5 100%);border-radius:10px;padding:14px;margin-bottom:16px;border:1px solid #bbf7d0}
  .sub-card h4{font-size:12px;color:#166534;margin-bottom:8px;font-weight:700;letter-spacing:0.5px}.sub-item{margin-bottom:6px}.sub-item-label{font-size:11px;font-weight:700;color:#166534}.sub-item-text{font-size:13px;color:var(--text);margin-top:1px}
  .overall-display{text-align:center;padding:14px;background:linear-gradient(135deg,#fef9c3 0%,#fef3c7 100%);border-radius:10px;margin:16px 0;border:1px solid #fbbf24}
  .overall-num{font-size:32px;font-weight:700;color:#1a1a1a}.overall-label{font-size:13px;color:var(--text-light)}
  .table-wrap{overflow-x:auto;margin:0 -20px;padding:0 20px}table{width:100%;border-collapse:collapse;font-size:13px}
  th{background:#1a1a1a;color:#fbbf24;padding:10px 8px;text-align:center;font-weight:600;font-size:11px;white-space:nowrap}
  th:first-child{border-radius:8px 0 0 0}th:last-child{border-radius:0 8px 0 0}td{padding:10px 8px;text-align:center;border-bottom:1px solid #f1f5f9}td:first-child{text-align:left;font-weight:700;color:#1a1a1a}
  .hist-item{border-bottom:1px solid #f1f5f9;padding-bottom:12px;margin-bottom:12px}.hist-item:last-child{border:none;margin:0;padding:0}
  .hist-top{display:flex;justify-content:space-between;align-items:center}.hist-date{font-weight:700;color:#1a1a1a;font-size:14px}
  .hist-badge{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:700}.hist-scores{display:flex;gap:12px;margin-top:6px;font-size:12px;color:var(--text-light);flex-wrap:wrap}
  .hist-comment{font-size:12px;color:var(--text-light);margin-top:4px;font-style:italic}.hist-meta{font-size:11px;color:var(--text-lighter);margin-top:2px}
  .pending-btn{display:block;width:100%;text-align:left;padding:12px 14px;border-radius:8px;border:1.5px solid var(--grey-border);background:#fff;cursor:pointer;margin-bottom:8px;font-family:inherit;transition:all 0.15s}
  .pending-btn:hover{border-color:#d97706;background:#fffbeb}.pending-date{font-weight:700;color:#1a1a1a;font-size:14px}.pending-preview{font-size:12px;color:var(--text-light);margin-top:3px}
  .alert-box{background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.3);border-radius:var(--radius);padding:16px}
  .alert-box h3{font-size:13px;color:#92400e;margin-bottom:10px;font-weight:700}.alert-item{display:flex;gap:8px;margin-bottom:5px;font-size:13px;color:var(--text)}.alert-num{font-weight:700;min-width:18px}
  .rating-row{display:flex;gap:10px;align-items:center;padding:8px 10px;margin-bottom:3px;border-radius:6px;font-size:13px}.rating-score{font-weight:700;min-width:75px}.rating-label{font-weight:700;min-width:120px}.rating-desc{color:var(--text-light)}
  .login-screen{min-height:100vh;background:linear-gradient(160deg,#d97706 0%,#fbbf24 40%,#fcd34d 100%);display:flex;align-items:center;justify-content:center;padding:20px;position:relative;overflow:hidden}
  .login-screen::before{content:'';position:absolute;inset:0;background:
    radial-gradient(ellipse 800px 600px at 20% 80%,rgba(255,255,255,0.1),transparent),
    radial-gradient(ellipse 600px 400px at 80% 20%,rgba(255,255,255,0.08),transparent);z-index:0}
  .login-screen::after{content:'';position:absolute;inset:0;opacity:0.04;z-index:0;
    background-image:
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='800'%3E%3Cellipse cx='400' cy='400' rx='350' ry='280' fill='none' stroke='%231a1a1a' stroke-width='1'/%3E%3Cellipse cx='400' cy='400' rx='300' ry='240' fill='none' stroke='%231a1a1a' stroke-width='0.8'/%3E%3Cellipse cx='400' cy='400' rx='250' ry='200' fill='none' stroke='%231a1a1a' stroke-width='0.8'/%3E%3Cellipse cx='400' cy='400' rx='200' ry='160' fill='none' stroke='%231a1a1a' stroke-width='0.6'/%3E%3Cellipse cx='400' cy='400' rx='150' ry='120' fill='none' stroke='%231a1a1a' stroke-width='0.6'/%3E%3Cellipse cx='400' cy='400' rx='100' ry='80' fill='none' stroke='%231a1a1a' stroke-width='0.5'/%3E%3Cellipse cx='200' cy='600' rx='180' ry='140' fill='none' stroke='%231a1a1a' stroke-width='0.6'/%3E%3Cellipse cx='650' cy='200' rx='140' ry='110' fill='none' stroke='%231a1a1a' stroke-width='0.6'/%3E%3C/svg%3E");
    background-size:100% 100%}
  .login-topo{display:none}
  .login-card{background:rgba(255,255,255,0.97);border-radius:20px;padding:36px;max-width:400px;width:100%;text-align:center;box-shadow:0 16px 64px rgba(0,0,0,0.15),0 0 0 1px rgba(0,0,0,0.05);position:relative;z-index:1;backdrop-filter:blur(10px)}
  .login-logo{height:48px;margin-bottom:8px}.login-brand{font-size:12px;font-weight:700;color:#d97706;letter-spacing:3px;margin-bottom:2px}
  .login-title{font-size:20px;color:#1a1a1a;font-weight:700;margin:6px 0 20px}.login-sub{font-size:13px;color:var(--text-light);margin-bottom:20px}
  .login-btn{display:block;width:100%;padding:13px;border-radius:10px;font-weight:700;font-size:14px;font-family:inherit;cursor:pointer;margin-bottom:10px;transition:all 0.2s}
  .login-btn-outline{background:#fff;color:#1a1a1a;border:2px solid #1a1a1a}.login-btn-outline:hover{background:#1a1a1a;color:#fbbf24}
  .login-btn-fill{background:#1a1a1a;color:#fbbf24;border:2px solid #1a1a1a;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
  .login-btn-fill:hover{box-shadow:0 4px 16px rgba(0,0,0,0.3);transform:translateY(-1px)}
  .login-back{background:none;border:none;color:var(--text-lighter);cursor:pointer;font-size:13px;font-family:inherit;margin-top:12px}
  .pin-input{width:140px;padding:12px;border-radius:10px;border:2px solid var(--grey-border);font-size:22px;text-align:center;letter-spacing:8px;font-family:inherit;transition:border-color 0.2s}
  .pin-input:focus{outline:none;border-color:#d97706}.pin-input.error{border-color:var(--red)}.pin-error{color:var(--red);font-size:13px;margin-top:6px}
  .toast{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:#1a1a1a;color:#fbbf24;padding:10px 24px;border-radius:10px;font-weight:600;font-size:14px;z-index:200;box-shadow:0 4px 20px rgba(0,0,0,0.3);animation:toastIn 0.3s ease}
  @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
  .empty{background:rgba(251,191,36,0.12);border-radius:var(--radius);padding:24px;text-align:center;color:#1a1a1a;font-size:14px;font-weight:600;border:1px dashed #d97706}
</style>
</head>
<body>
<div id="app"></div>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js" onerror="window._fbFail=true"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js" onerror="window._fbFail=true"></script>
<script>
// =====================================================
// FIREBASE CONFIG — REPLACE WITH YOUR OWN VALUES
// =====================================================
const firebaseConfig={apiKey:"AIzaSyAfSpsRXf6gpn0ZORkC7T8Z-O9zAlhbGSo",authDomain:"kahuto-performance-tracker.firebaseapp.com",databaseURL:"https://kahuto-performance-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"kahuto-performance-tracker",storageBucket:"kahuto-performance-tracker.firebasestorage.app",messagingSenderId:"567102331840",appId:"1:567102331840:web:75c4410e2e46a55aaec625"};

// =====================================================
// SETTINGS — EDIT THESE AS NEEDED
// =====================================================
let STAFF=["Solomon Chant","Kavitesh Prasad","Neha Naidu","Geeta Singh","Jone Nawele","Audrey D'Cruz","Jennifer Cortez"];
const DEFAULT_STAFF=[...STAFF];
let QUESTIONS=[
{id:"project",label:"What project work did you do?",hint:"Be specific — which site, what task. If none, write \"No active projects.\""},
{id:"training",label:"What did you learn or train on?",hint:"Courses, tutorials, software practice. If nothing, write \"None.\""},
{id:"initiative",label:"What did you do WITHOUT being asked?",hint:"Fixed something? Improved a process? Organised files?"},
{id:"crossTraining",label:"Cross-training (taught or learned from a colleague)?",hint:"Who and what?"},
{id:"blockers",label:"Blockers or notes?",hint:"Challenges, equipment issues, things you need"}
];
const MANAGERS=["Chris","Nina","Nikhil"];
const MANAGER_PIN="3226";
const CRITERIA=["Productivity","Initiative","Quality","Development"];
const LOGO_W="https://content.app-sources.com/s/615296968844647021/uploads/Logos/Kahuto_Logo_White-2226739.png?format=webp";
const LOGO_O="https://content.app-sources.com/s/615296968844647021/thumbnails/640x480/Logos/Kahuto_Short_Logo_White_MID_OWL_2-2482212.png?format=webp";
const OWL_SVG='<svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="24" cy="24" r="22" fill="#162a3a" stroke="#2a9d8f" stroke-width="2"/><circle cx="17" cy="21" r="6" fill="#2a9d8f" opacity="0.3"/><circle cx="31" cy="21" r="6" fill="#2a9d8f" opacity="0.3"/><circle cx="17" cy="21" r="3" fill="#2a9d8f"/><circle cx="31" cy="21" r="3" fill="#2a9d8f"/><circle cx="17" cy="20" r="1" fill="#fff"/><circle cx="31" cy="20" r="1" fill="#fff"/><path d="M21 28 L24 32 L27 28" stroke="#2a9d8f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 12 Q14 8 18 14" stroke="#2a9d8f" stroke-width="1.5" fill="none"/><path d="M38 12 Q34 8 30 14" stroke="#2a9d8f" stroke-width="1.5" fill="none"/></svg>';
const OWL_SVG_SM='<svg width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="24" cy="24" r="22" fill="#0c1821" stroke="#2a9d8f" stroke-width="2"/><circle cx="17" cy="21" r="6" fill="#2a9d8f" opacity="0.3"/><circle cx="31" cy="21" r="6" fill="#2a9d8f" opacity="0.3"/><circle cx="17" cy="21" r="3" fill="#2a9d8f"/><circle cx="31" cy="21" r="3" fill="#2a9d8f"/><circle cx="17" cy="20" r="1" fill="#fff"/><circle cx="31" cy="20" r="1" fill="#fff"/><path d="M21 28 L24 32 L27 28" stroke="#2a9d8f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 12 Q14 8 18 14" stroke="#2a9d8f" stroke-width="1.5" fill="none"/><path d="M38 12 Q34 8 30 14" stroke="#2a9d8f" stroke-width="1.5" fill="none"/></svg>';
const BETWEEN=[
"Equipment maintenance & calibration (drones, GPR, GPS, scanners)",
"Online training — QGIS, CloudCompare, LiDAR processing",
"Shadow a colleague — learn a skill you don't have",
"Improve SOPs, templates, checklists, or field procedures",
"Practice processing on sample/test datasets",
"Organise and back up project files & deliverables",
"Read technical articles or watch tutorials",
"Propose an idea or improvement to management"];
const RATINGS=[
{range:"4.5 – 5.0",label:"Outstanding",color:"#dcfce7",desc:"Exceeds expectations consistently"},
{range:"3.5 – 4.4",label:"Good",color:"#dcfce7",desc:"Solid performer, shows initiative"},
{range:"2.5 – 3.4",label:"Meets Expectations",color:"#fef9c3",desc:"Does what's asked, rarely more"},
{range:"1.5 – 2.4",label:"Below Average",color:"#fee2e2",desc:"Needs improvement"},
{range:"1.0 – 1.4",label:"Poor",color:"#fee2e2",desc:"Immediate action required"}];
let S={screen:"login",role:null,user:null,mt:"evaluate",es:STAFF[0],ew:null,sc:{},ec:"",logs:{},evals:{},toast:null};

// =====================================================
// STORAGE — Firebase with localStorage fallback
// =====================================================
let db=null;
let useLocal=false;
try{
  if(typeof firebase!=="undefined"&&!window._fbFail){
    firebase.initializeApp(firebaseConfig);db=firebase.database();
  }else{useLocal=true}
}catch(e){useLocal=true;console.log("Using local storage mode")}

function lsGet(k){try{return JSON.parse(localStorage.getItem(k))||{}}catch(e){return{}}}
function lsSave(){try{localStorage.setItem("kp_logs",JSON.stringify(S.logs));localStorage.setItem("kp_evals",JSON.stringify(S.evals))}catch(e){}}

function loadData(cb){
  if(useLocal||!db){S.logs=lsGet("kp_logs");S.evals=lsGet("kp_evals");const ls=lsGet("kp_staff");if(ls&&ls.length)STAFF=ls;const lq=lsGet("kp_questions");if(lq&&lq.length)QUESTIONS=lq;cb();return}
  db.ref("staff").on("value",s=>{const v=s.val();if(v&&v.length){STAFF=v;S.es=STAFF[0]}render()});
  db.ref("questions").on("value",s=>{const v=s.val();if(v&&v.length)QUESTIONS=v;render()});
  db.ref("logs").on("value",s=>{S.logs=s.val()||{};render()});
  db.ref("evals").on("value",s=>{S.evals=s.val()||{};render()});cb();
}
async function saveStaff(){
  if(!useLocal&&db){await db.ref("staff").set(STAFF)}else{try{localStorage.setItem("kp_staff",JSON.stringify(STAFF))}catch(e){}}
}
async function saveQuestions(){
  if(!useLocal&&db){await db.ref("questions").set(QUESTIONS)}else{try{localStorage.setItem("kp_questions",JSON.stringify(QUESTIONS))}catch(e){}}
}
async function saveLog(k,d){
  S.logs[k]=d;
  if(!useLocal&&db){await db.ref("logs/"+k).set(d)}else{lsSave()}
}
async function saveEval(k,d){
  S.evals[k]=d;
  if(!useLocal&&db){await db.ref("evals/"+k).set(d)}else{lsSave()}
}
async function resetAll(){
  S.logs={};S.evals={};
  if(!useLocal&&db){await db.ref("logs").remove();await db.ref("evals").remove()}else{lsSave()}
}
function gw(){const d=new Date(),dy=d.getDay(),df=d.getDate()-dy+(dy===0?-6:5),f=new Date(d);f.setDate(df);return f.toISOString().split("T")[0]}
function fd(s){if(!s)return"";return new Date(s+"T00:00:00").toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}
function sk(s){return s.replace(/[.#$\/\[\]]/g,"_")}
function gl(n){return Object.entries(S.logs).filter(([_,l])=>l.staff===n).map(([k,v])=>({...v,_k:k})).sort((a,b)=>b.week.localeCompare(a.week))}
function ge(n){return Object.entries(S.evals).filter(([_,e])=>e.staff===n).map(([k,v])=>({...v,_k:k})).sort((a,b)=>b.week.localeCompare(a.week))}
function gu(n){return gl(n).filter(l=>!S.evals[sk(n+"-"+l.week)])}
function af(n,f){const e=ge(n);if(!e.length)return null;const v=e.map(x=>x.scores&&x.scores[f]).filter(Boolean);return v.length?Math.round(v.reduce((a,b)=>a+b,0)/v.length*10)/10:null}
function oa(n){const e=ge(n);if(!e.length)return null;const v=e.map(x=>x.overall).filter(Boolean);return v.length?Math.round(v.reduce((a,b)=>a+b,0)/v.length*10)/10:null}
function gr(s){if(!s)return{label:"-",color:"#f3f4f6"};if(s>=4.5)return RATINGS[0];if(s>=3.5)return RATINGS[1];if(s>=2.5)return RATINGS[2];if(s>=1.5)return RATINGS[3];return RATINGS[4]}
function toast(m){S.toast=m;render();setTimeout(()=>{S.toast=null;render()},3000)}
function $(id){return document.getElementById(id)}
function render(){const a=$("app");if(S.screen==="login")a.innerHTML=loginScr();else if(S.screen==="staffSel")a.innerHTML=staffSelScr();else if(S.screen==="mgrPin")a.innerHTML=mgrPinScr();else if(S.screen==="staffApp")a.innerHTML=staffAppScr();else if(S.screen==="mgrApp")a.innerHTML=mgrAppScr();bindEv()}
function loginScr(){return'<div class="login-screen"><div class="login-card"><div class="login-brand">KAHUTO PACIFIC</div><h1 class="login-title">Performance Tracker</h1><p class="login-sub">Select your role to continue</p><button class="login-btn login-btn-outline" data-action="goStaff">I\'m Staff — Submit Weekly Log</button><button class="login-btn login-btn-fill" data-action="goMgr">I\'m a Manager — Evaluate Staff</button></div></div>'}
function staffSelScr(){return'<div class="login-screen"><div class="login-card" style="max-width:420px"><div class="login-brand">KAHUTO PACIFIC</div><h1 class="login-title">Who are you?</h1><div style="max-height:380px;overflow-y:auto;padding:4px 0">'+STAFF.map(s=>'<button class="login-btn login-btn-outline" data-action="selStaff" data-name="'+s+'" style="font-size:14px;padding:12px">'+s+'</button>').join('')+'</div><button class="login-back" data-action="back">← Back</button></div></div>'}
function mgrPinScr(){return'<div class="login-screen"><div class="login-card"><div class="login-brand">KAHUTO PACIFIC</div><h1 class="login-title">Manager Access</h1><p class="login-sub">Enter PIN to continue</p><input type="password" id="pin" class="pin-input" maxlength="4" placeholder="••••" autocomplete="off"><div id="pinErr" class="pin-error hidden">Wrong PIN</div><div style="margin-top:16px">'+MANAGERS.map(m=>'<button class="login-btn login-btn-fill" data-action="loginMgr" data-name="'+m+'" style="margin-bottom:8px">Continue as '+m+'</button>').join('')+'</div><button class="login-back" data-action="back">← Back</button></div></div>'}
function staffAppScr(){const n=S.user,w=gw(),ex=S.logs[sk(n+"-"+w)],ml=gl(n);
return'<div class="header"><div class="header-left"><div><div class="header-brand">PERFORMANCE TRACKER</div><div class="header-title">'+n+'</div></div></div><button class="btn-logout" data-action="logout">Logout</button></div>'+(S.toast?'<div class="toast">'+S.toast+'</div>':'')+'<div class="container"><div class="card"><div class="card-title">Submit This Week\'s Log</div><div class="card-sub">Week ending: <strong>'+fd(w)+'</strong>'+(ex?' <span style="color:#f59e0b">(Already submitted — will update)</span>':'')+'</div><div class="form-group"><label class="form-label">Week Ending Date</label><input type="date" id="lw" class="form-input" value="'+w+'"></div>'+
QUESTIONS.map(q=>'<div class="form-group"><label class="form-label">'+q.label+'</label><div class="form-hint">'+q.hint+'</div><textarea id="q_'+q.id+'" class="form-textarea" rows="3">'+(ex&&ex[q.id]||"")+'</textarea></div>').join('')+
'<button class="btn btn-primary" data-action="subLog">'+(ex?"Update Log":"Submit Log")+'</button></div>'+
(ml.length?'<div class="card"><div class="card-title">My Past Submissions</div>'+ml.map(l=>{const ev=S.evals[sk(n+"-"+l.week)],r=ev?gr(ev.overall):null,preview=QUESTIONS.map(q=>l[q.id]).filter(Boolean)[0]||"";return'<div class="hist-item"><div class="hist-top"><span class="hist-date">'+fd(l.week)+'</span>'+(ev?'<span class="hist-badge" style="background:'+r.color+'">'+ev.overall+'/5</span>':'<span style="color:var(--text-lighter);font-size:12px">Pending review</span>')+'</div><p style="font-size:12px;color:var(--text-light);margin-top:4px">'+preview.substring(0,100)+(preview.length>100?"...":"")+'</p></div>'}).join('')+'</div>':'')+
'<div class="alert-box"><h3>No Active Projects? Here\'s What You Should Be Doing:</h3>'+BETWEEN.map((x,i)=>'<div class="alert-item"><span class="alert-num">'+(i+1)+'.</span><span>'+x+'</span></div>').join('')+'</div></div>'}
function mgrAppScr(){const au=STAFF.reduce((n,s)=>n+gu(s).length,0);
return'<div class="header"><div class="header-left"><div><div class="header-brand">PERFORMANCE TRACKER</div><div class="header-title">Manager — '+S.user+'</div></div></div><div style="display:flex;gap:6px"><button class="btn-danger" data-action="reset">Reset</button><button class="btn-logout" data-action="logout">Logout</button></div></div>'+(S.toast?'<div class="toast">'+S.toast+'</div>':'')+
'<div class="tabs"><button class="tab '+(S.mt==="evaluate"?"active":"")+'" data-action="tab" data-tab="evaluate">Evaluate'+(au>0?' <span class="badge">'+au+'</span>':'')+'</button><button class="tab '+(S.mt==="dashboard"?"active":"")+'" data-action="tab" data-tab="dashboard">Dashboard</button><button class="tab '+(S.mt==="history"?"active":"")+'" data-action="tab" data-tab="history">History</button><button class="tab '+(S.mt==="team"?"active":"")+'" data-action="tab" data-tab="team">Team</button></div><div class="container">'+(S.mt==="evaluate"?evalTab():"")+(S.mt==="dashboard"?dashTab():"")+(S.mt==="history"?histTab():"")+(S.mt==="team"?teamTab():"")+'</div>'}
function evalTab(){const es=S.es,pend=gu(es),ew=S.ew,log=ew?S.logs[sk(es+"-"+ew)]:null;
let c='<div class="staff-btns">'+STAFF.map(s=>{const p=gu(s).length;return'<button class="staff-btn '+(S.es===s?"active":"")+'" data-action="setES" data-name="'+s+'">'+s.split(" ")[0]+(p>0?' <span class="badge">'+p+'</span>':'')+'</button>'}).join('')+'</div>';
if(!ew){if(!pend.length)c+='<div class="empty">No pending logs for '+es.split(" ")[0]+'. All caught up! ✓</div>';
else{c+='<div class="card"><div class="card-title">Pending Evaluations — '+es+'</div>';pend.forEach(l=>{const preview=QUESTIONS.map(q=>l[q.id]).filter(Boolean)[0]||"";c+='<button class="pending-btn" data-action="startEv" data-week="'+l.week+'"><div class="pending-date">'+fd(l.week)+'</div><div class="pending-preview">'+preview.substring(0,80)+'...</div></button>'});c+='</div>'}}
else if(log){const allSc=CRITERIA.every(cr=>S.sc[cr]);
c+='<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div class="card-title" style="margin:0">Evaluating '+es+' — '+fd(ew)+'</div><button class="btn-back" data-action="cancelEv">← Back</button></div>';
c+='<div class="sub-card"><h4>THEIR SUBMISSION</h4>';
QUESTIONS.forEach(q=>{if(log[q.id])c+='<div class="sub-item"><div class="sub-item-label">'+q.label.replace(/\?$/,"")+':</div><div class="sub-item-text">'+log[q.id]+'</div></div>'});
c+='</div><h4 style="font-size:14px;color:#1a1a1a;margin-bottom:12px">Your Scores</h4>';
CRITERIA.forEach(cr=>{c+='<div class="score-row"><span class="score-label">'+cr+'</span><div class="score-btns">';[1,2,3,4,5].forEach(v=>{c+='<button class="score-btn '+(S.sc[cr]===v?"sel":"")+'" data-v="'+v+'" data-action="score" data-cr="'+cr+'" data-val="'+v+'">'+v+'</button>'});c+='</div></div>'});
if(allSc)c+='<div class="overall-display"><div class="overall-label">Overall Score</div><div class="overall-num">'+(CRITERIA.reduce((s,cr)=>s+S.sc[cr],0)/4).toFixed(1)+'</div><div class="overall-label">/ 5</div></div>';
c+='<div class="form-group"><textarea id="ec" class="form-textarea" rows="2" placeholder="Any comments? (optional)">'+S.ec+'</textarea></div><button class="btn btn-primary" data-action="subEval" '+(allSc?"":"disabled")+'>Save Evaluation</button></div>'}
return c}
function dashTab(){return'<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div class="card-title" style="margin:0">Team Comparison</div><div style="display:flex;gap:6px"><button style="background:#1a1a1a;color:#fbbf24;border:none;padding:6px 12px;border-radius:6px;font-size:11px;font-weight:700;font-family:inherit;cursor:pointer" data-action="dlSummary">⬇ Summary</button><button style="background:#1a1a1a;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:11px;font-weight:700;font-family:inherit;cursor:pointer" data-action="dlFull">⬇ Full Data</button></div></div><div class="table-wrap"><table><thead><tr><th>Staff</th><th>Wks</th>'+CRITERIA.map(c=>'<th>'+c.substring(0,4)+'</th>').join('')+'<th>OVERALL</th></tr></thead><tbody>'+STAFF.map(s=>{const o=oa(s),r=gr(o);return'<tr><td>'+s.split(" ")[0]+'</td><td>'+ge(s).length+'</td>'+CRITERIA.map(c=>'<td style="font-weight:600">'+(af(s,c)??"-")+'</td>').join('')+'<td style="font-weight:700;font-size:15px;color:#1a1a1a;background:'+r.color+'">'+(o??"-")+'</td></tr>'}).join('')+'</tbody></table></div></div><div class="card"><div class="card-title">Rating Guide</div>'+RATINGS.map(r=>'<div class="rating-row" style="background:'+r.color+'"><span class="rating-score">'+r.range+'</span><span class="rating-label">'+r.label+'</span><span class="rating-desc">'+r.desc+'</span></div>').join('')+'</div><div class="alert-box"><h3>Between Projects — Expected Activities</h3>'+BETWEEN.map((x,i)=>'<div class="alert-item"><span class="alert-num">'+(i+1)+'.</span><span>'+x+'</span></div>').join('')+'</div>'}
function histTab(){return STAFF.map(s=>{const evs=ge(s),o=oa(s);return'<div class="card"><div class="card-title">'+s+'</div><div class="card-sub">'+evs.length+' week'+(evs.length!==1?"s":"")+" evaluated"+(o?" • Overall: "+o+"/5":"")+'</div>'+(evs.length===0?'<div class="empty">No evaluations yet.</div>':evs.map(ev=>{const r=gr(ev.overall),log=S.logs[sk(s+"-"+ev.week)],preview=log?QUESTIONS.map(q=>log[q.id]).filter(Boolean)[0]||"":"";return'<div class="hist-item"><div class="hist-top"><span class="hist-date">'+fd(ev.week)+'</span><span class="hist-badge" style="background:'+r.color+'">'+ev.overall+'/5 — '+r.label+'</span></div><div class="hist-scores">'+CRITERIA.map(c=>'<span>'+c+': <strong>'+ev.scores[c]+'</strong></span>').join('')+'</div>'+(ev.comment?'<div class="hist-comment">"'+ev.comment+'"</div>':'')+(preview?'<p style="font-size:11px;color:var(--text-lighter);margin-top:2px">'+preview.substring(0,80)+'</p>':'')+'<div class="hist-meta">Evaluated by '+ev.evaluator+'</div></div>'}).join(''))+'</div>'}).join('')}
function teamTab(){
return'<div class="card"><div class="card-title">Manage Staff</div><div class="card-sub">Add or remove team members. Changes take effect immediately.</div>'+
STAFF.map((s,i)=>'<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f1f5f9"><span style="font-weight:600;font-size:14px">'+s+'</span><button style="background:rgba(220,38,38,0.08);color:#dc2626;border:none;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;font-family:inherit;cursor:pointer" data-action="removeStaff" data-idx="'+i+'">Remove</button></div>').join('')+
'<div style="display:flex;gap:8px;margin-top:16px"><input type="text" id="newStaff" class="form-input" placeholder="Full name (e.g. Nikhil Singh)" style="flex:1"><button style="background:#1a1a1a;color:#fbbf24;border:none;padding:10px 20px;border-radius:8px;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;white-space:nowrap" data-action="addStaff">+ Add</button></div></div>'+
'<div class="card"><div class="card-title">Weekly Log Questions</div><div class="card-sub">Edit the questions staff see when submitting their weekly log. Drag to reorder coming soon.</div>'+
QUESTIONS.map((q,i)=>'<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:10px"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px"><span style="font-weight:700;font-size:13px;color:#1a1a1a">Q'+(i+1)+'</span><div style="display:flex;gap:4px">'+(i>0?'<button style="background:#f1f5f9;border:1px solid #e2e8f0;padding:3px 8px;border-radius:4px;cursor:pointer;font-size:11px;font-family:inherit" data-action="moveQUp" data-idx="'+i+'">↑</button>':'')+
(i<QUESTIONS.length-1?'<button style="background:#f1f5f9;border:1px solid #e2e8f0;padding:3px 8px;border-radius:4px;cursor:pointer;font-size:11px;font-family:inherit" data-action="moveQDown" data-idx="'+i+'">↓</button>':'')+
'<button style="background:rgba(220,38,38,0.08);color:#dc2626;border:none;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600;font-family:inherit;cursor:pointer" data-action="removeQ" data-idx="'+i+'">✕</button></div></div>'+
'<div style="margin-bottom:6px"><label style="font-size:11px;color:var(--text-lighter);font-weight:600">Question</label><input type="text" class="form-input" id="ql_'+i+'" value="'+q.label.replace(/"/g,'&quot;')+'" style="font-size:13px;margin-top:2px"></div>'+
'<div><label style="font-size:11px;color:var(--text-lighter);font-weight:600">Hint text</label><input type="text" class="form-input" id="qh_'+i+'" value="'+q.hint.replace(/"/g,'&quot;')+'" style="font-size:12px;margin-top:2px;color:var(--text-light)"></div></div>').join('')+
'<div style="display:flex;gap:8px;margin-top:12px"><button style="background:#1a1a1a;color:#fbbf24;border:none;padding:10px 20px;border-radius:8px;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;white-space:nowrap" data-action="addQ">+ Add Question</button>'+
'<button style="background:#fbbf24;color:#1a1a1a;border:none;padding:10px 20px;border-radius:8px;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;flex:1" data-action="saveQ">Save Questions</button></div></div>'+
'<div class="card"><div class="card-title">Manage Managers</div><div class="card-sub">Current managers who can evaluate staff.</div>'+
MANAGERS.map(m=>'<div style="padding:8px 0;border-bottom:1px solid #f1f5f9;font-weight:600;font-size:14px">'+m+'</div>').join('')+
'<p style="font-size:12px;color:var(--text-lighter);margin-top:12px"></p></div>'+
'<div class="card"><div class="card-title">Manager PIN</div><div style="font-size:14px;font-weight:600;color:#1a1a1a">'+MANAGER_PIN+'</div><p style="font-size:12px;color:var(--text-lighter);margin-top:4px"></p></div>'}
function bindEv(){document.querySelectorAll("[data-action]").forEach(el=>{el.onclick=e=>{e.preventDefault();ha(el.dataset.action,el.dataset)}})}
async function ha(a,d){switch(a){
case"goStaff":S.screen="staffSel";S.role="staff";break;
case"goMgr":S.screen="mgrPin";S.role="manager";break;
case"back":S.screen="login";S.role=null;S.user=null;break;
case"selStaff":S.user=d.name;S.screen="staffApp";break;
case"loginMgr":{const p=$("pin").value;if(p===MANAGER_PIN){S.user=d.name;S.screen="mgrApp";S.mt="evaluate"}else{$("pin").classList.add("error");$("pinErr").classList.remove("hidden");return}break}
case"logout":S.screen="login";S.role=null;S.user=null;S.ew=null;S.sc={};S.ec="";break;
case"tab":S.mt=d.tab;break;
case"setES":S.es=d.name;S.ew=null;S.sc={};S.ec="";break;
case"startEv":S.ew=d.week;S.sc={};S.ec="";break;
case"cancelEv":S.ew=null;S.sc={};S.ec="";break;
case"score":S.sc[d.cr]=parseInt(d.val);break;
case"subLog":{const w=$("lw").value;const answers={};let hasAny=false;QUESTIONS.forEach(q=>{const el=$("q_"+q.id);const v=el?el.value.trim():"";answers[q.id]=v;if(v)hasAny=true});if(!hasAny){alert("Please fill in at least one field.");return}const k=sk(S.user+"-"+w);await saveLog(k,{staff:S.user,week:w,...answers,submittedAt:new Date().toISOString()});toast("Weekly log submitted!");return}
case"subEval":{if(!CRITERIA.every(c=>S.sc[c]))return;const cm=$("ec")?$("ec").value.trim():"",avg=CRITERIA.reduce((s,c)=>s+S.sc[c],0)/4,k=sk(S.es+"-"+S.ew);await saveEval(k,{staff:S.es,week:S.ew,scores:{...S.sc},overall:Math.round(avg*10)/10,evaluator:S.user,comment:cm,evaluatedAt:new Date().toISOString()});S.ew=null;S.sc={};S.ec="";toast("Evaluation saved!");return}
case"reset":{if(!confirm("DELETE all data? Cannot be undone."))return;await resetAll();toast("All data cleared.");break}
case"dlFull":exportCSV();return;
case"dlSummary":exportSummaryCSV();return;
case"addStaff":{const inp=$("newStaff");const name=inp?inp.value.trim():"";if(!name){alert("Enter a name.");return}if(STAFF.includes(name)){alert(name+" is already on the list.");return}STAFF.push(name);await saveStaff();toast(name+" added!");break}
case"removeStaff":{const idx=parseInt(d.idx);const name=STAFF[idx];if(!confirm("Remove "+name+" from the team?\n\nTheir past logs and evaluations will be kept.")){return}STAFF.splice(idx,1);if(S.es===name)S.es=STAFF[0]||"";await saveStaff();toast(name+" removed.");break}
case"addQ":{QUESTIONS.push({id:"q_"+Date.now(),label:"New question?",hint:"Add a hint for staff"});break}
case"removeQ":{const qi=parseInt(d.idx);if(QUESTIONS.length<=1){alert("You need at least one question.");return}if(!confirm("Remove question: \""+QUESTIONS[qi].label+"\"?")){return}QUESTIONS.splice(qi,1);break}
case"moveQUp":{const qi=parseInt(d.idx);if(qi>0){const tmp=QUESTIONS[qi];QUESTIONS[qi]=QUESTIONS[qi-1];QUESTIONS[qi-1]=tmp}break}
case"moveQDown":{const qi=parseInt(d.idx);if(qi<QUESTIONS.length-1){const tmp=QUESTIONS[qi];QUESTIONS[qi]=QUESTIONS[qi+1];QUESTIONS[qi+1]=tmp}break}
case"saveQ":{QUESTIONS.forEach((q,i)=>{const lEl=$("ql_"+i);const hEl=$("qh_"+i);if(lEl)q.label=lEl.value.trim()||"Question "+(i+1);if(hEl)q.hint=hEl.value.trim()});await saveQuestions();toast("Questions saved!");break}
}render()}
function exportCSV(){
const rows=[["Staff","Week",...QUESTIONS.map(q=>q.label),"Productivity","Initiative Score","Quality","Development","Overall","Rating","Evaluator","Comment"]];
STAFF.forEach(s=>{const logs=gl(s);logs.forEach(l=>{const ev=S.evals[sk(s+"-"+l.week)];const r=ev?gr(ev.overall):{label:""};rows.push([s,l.week,...QUESTIONS.map(q=>'"'+(l[q.id]||"").replace(/"/g,'""')+'"'),ev?ev.scores.Productivity:"",ev?ev.scores.Initiative:"",ev?ev.scores.Quality:"",ev?ev.scores.Development:"",ev?ev.overall:"",r.label,ev?ev.evaluator:"",'"'+(ev&&ev.comment||"").replace(/"/g,'""')+'"'])})});
if(rows.length<2){alert("No data to export.");return}
const csv=rows.map(r=>r.join(",")).join("\n");
const blob=new Blob([csv],{type:"text/csv"});
const url=URL.createObjectURL(blob);
const a=document.createElement("a");a.href=url;a.download="kahuto_performance_"+new Date().toISOString().split("T")[0]+".csv";a.click();URL.revokeObjectURL(url)}
function exportSummaryCSV(){
const rows=[["Staff","Weeks Evaluated","Productivity Avg","Initiative Avg","Quality Avg","Development Avg","Overall Avg","Rating"]];
STAFF.forEach(s=>{const o=oa(s),r=gr(o);rows.push([s,ge(s).length,af(s,"Productivity")||"",af(s,"Initiative")||"",af(s,"Quality")||"",af(s,"Development")||"",o||"",r.label])});
const csv=rows.map(r=>r.join(",")).join("\n");
const blob=new Blob([csv],{type:"text/csv"});
const url=URL.createObjectURL(blob);
const a=document.createElement("a");a.href=url;a.download="kahuto_summary_"+new Date().toISOString().split("T")[0]+".csv";a.click();URL.revokeObjectURL(url)}
loadData(()=>render());
</script>
</body>
</html>
